---
title: "R Notebook"
output:
  pdf_document: default
  html_notebook: default
---


```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
options(max.print=10)
options(warn=-1)
require(dplyr)
require(ggplot2)
require(GGally)
require(RSQLite)
require(reshape2)


db_path = "../resources/model_2019-03-10_01-24-49_100iter.db"
con <- RSQLite::dbConnect(RSQLite::SQLite(), db_path)
victory_stats <- dbReadTable(con, "result_analysis")
game_data <- dbReadTable(con, "game")
dbDisconnect(con)
victory_stats <- victory_stats %>% mutate(diffD=Ds-Dc)
victory_stats <- victory_stats %>% group_by(Size,C,Ds,Dc,diffD) %>% summarize(victory_percent=sum(victory=="True")/n()) %>% ungroup()
```


# Victory conditions overview
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
basic_analysis <- function(victory_stats, title){
  dat.long<-melt(victory_stats,id.vars="victory_percent")
  return(ggplot(dat.long, aes(value,victory_percent, color=victory_percent, fill=victory_percent))+
    geom_bar(data=subset(dat.long,variable=="Size"), stat = "identity", position="dodge")+
    geom_bar(data=subset(dat.long,variable=="C"), stat = "identity", position="dodge") +
    geom_bar(data=subset(dat.long,variable=="Ds"), stat = "identity", position="dodge")+
    geom_bar(data=subset(dat.long,variable=="Dc"), stat = "identity", position="dodge")+
    geom_bar(data=subset(dat.long,variable=="diffD"), stat = "identity", position="dodge")+
    facet_grid(.~variable,scales = "free_x")+
    scale_fill_gradient( low="red", high="green")+
    scale_color_gradient(low="red", high="green")+
    scale_alpha_continuous(range=c(0.1,0.5))+
    ggtitle(title))
}

readablegraph <- function(data, mapping, ...){#make ggplot2 plot
      ggplot(data, mapping)+
        geom_bar(stat="identity", position="dodge")+
        scale_fill_gradient( low="red", high="green")
}


analyze_data <- function(victory_stats, title){
  
  print(basic_analysis(victory_stats, title))
  
}

analyze_binned_data<- function(data, title){
  dat.long<-melt(data,id.vars=c("victory_percent", "bin"))
  return(ggplot(dat.long, aes(value,victory_percent, fill=victory_percent))+
    geom_bar(data=subset(dat.long,variable=="Size"), stat="identity", position="dodge") +
    geom_bar(data=subset(dat.long,variable=="C"), stat="identity", position="dodge") +
    geom_bar(data=subset(dat.long,variable=="Ds"), stat="identity", position="dodge")+
    geom_bar(data=subset(dat.long,variable=="Dc"), stat="identity", position="dodge")+
    geom_bar(data=subset(dat.long,variable=="diffD"), stat="identity", position="dodge")+
    facet_grid(bin~variable,scales = "free_x")+
    scale_color_gradient(low="red", high="green")+
    scale_fill_gradient(low="red", high="green")+
    scale_alpha_continuous(range=c(0.1,0.5))+
    ggtitle(title))
}

analyze_binned_victory_data<- function(data, title){
  dat.long<-melt(data,id.vars=c("victory_percent", "bin"))
  return(ggplot(dat.long, aes(value,victory_percent, color=victory_percent, fill=victory_percent))+
    geom_bar(data=subset(dat.long,variable=="Size"), stat = "identity", position="dodge")+
    geom_bar(data=subset(dat.long,variable=="C"), stat = "identity", position="dodge")+
    geom_bar(data=subset(dat.long,variable=="Ds"), stat = "identity", position="dodge")+
    geom_bar(data=subset(dat.long,variable=="Dc"), stat = "identity", position="dodge")+
    geom_bar(data=subset(dat.long,variable=="diffD"), stat = "identity", position="dodge")+
    facet_grid(bin~variable,scales = "free_x")+
    scale_color_gradient(low="red", high="green")+
    scale_fill_gradient(low="red", high="green")+
    scale_alpha_continuous(range=c(0.1,0.5))+
    ggtitle(title))+
    theme_minimal()
}
```

# Analyzing victory stats:

## whole data set

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
analyze_data(victory_stats, "Whole dataset")
```

## Locking victory percents into 5 equally spaced intervals

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
binned_data <- victory_stats %>% group_by(bin=cut(victory_percent, seq(min(victory_percent), max(victory_percent), by = (max(victory_percent)-min(victory_percent))/3), include.lowest=T))
analyze_binned_victory_data(binned_data, "Analysis per victory percent interval")
```




## Locking C into 5 equally spaced intervals

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
binned_data <- victory_stats %>% group_by(bin=cut(C, seq(min(C), max(C), by = (max(C)-min(C))/4), include.lowest=T))
analyze_binned_data(binned_data, "Analysis per C interval")
```


## Locking Ds into 5 equally spaced intervals

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
binned_data <- victory_stats %>% group_by(bin=cut(Ds, seq(min(Ds), max(Ds), by = (max(Ds)-min(Ds))/4), include.lowest=T))
analyze_binned_data(binned_data, "Analysis per Ds interval")
```


## Locking Dc into 5 equally spaced intervals

```{r echo=FALSE, message=FALSE, warning=FALSE}
binned_data <- victory_stats %>% group_by(bin=cut(Dc, seq(min(Dc), max(Dc), by = (max(Dc)-min(Dc))/4), include.lowest=T))
analyze_binned_data(binned_data, "Analysis per Dc interval")
```

## Locking area into 5 equally spaced intervals

```{r echo=FALSE, message=FALSE, warning=FALSE}
binned_data <- victory_stats %>% group_by(bin=Size)
analyze_binned_data(binned_data, "Analysis per area interval")
```

## Locking Ds-Dc into 5 equally spaced intervals

```{r echo=FALSE, message=FALSE, warning=FALSE}
binned_data <- victory_stats %>% group_by(bin=cut(diffD, seq(min(diffD), max(diffD), by = (max(diffD)-min(diffD))/4), include.lowest=T))
analyze_binned_data(binned_data, "Analysis per Ds-Dc interval")
```